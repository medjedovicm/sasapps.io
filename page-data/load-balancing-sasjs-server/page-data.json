{"componentChunkName":"component---src-templates-template-tsx","path":"/load-balancing-sasjs-server","result":{"data":{"site":{"meta":{"title":"SAS Apps - Unleash Your Analytics","description":"Custom Interfaces to the world's most powerful Analytics Platform","siteUrl":"https://sasapps.io","author":"Allan Bowe","twitter":"","adsense":""}},"post":{"id":"763feb66-f858-51af-a2b0-e223a8dda498","html":"<p><a href=\"https://server.sasjs.io\">SASjs Server</a> does not ship with a load balancer.  However it does ‚Äúplay nicely‚Äù with existing load balancers - such as nginx.  This enables deployment in a similar topology to that of legacy SAS/IntrNet servers or Stored Process Web Apps.</p>\n<p>In this guide we will demonstrate how to configure nginx against three backend instances of SASjs Server.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 463px; margin-bottom: 1.0725rem;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.4468085106383%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAADtUlEQVQ4y3VUC0+TSRT9kBhMgEYKmiBgRGMw0NUgmG0Muz5IRP0BYkg0/hzkpb9iiUY0MSyEh3V5Q0FBiEhLC5S2QIECBcqbHu8ZO7U17iS38/XOvWfu49wxIKu/vx9ZWVlIS0uDOTMLKadS8eZNE9rb25GUlITTpzOQKfrUVBPs9mHU1dXBMAxkZGTImRl55/MxPz9PKBj86erqQn7+BeTlXcSVy8kothhobHyF1tZWuSgT2dnnUXw1CUUFBgYH7agXQLPZjHPnsmEtMXD9mgkzs96fgDabDaWlpXj0qArPqs7iTtkJvH7dhJaWf1FUZEFVVSWeVKajzJoi2QhgfS2s1jI8rqzA08qTKLuZB5fb8xOwt7cXOTk5sFgsuH3LioKCK2hqeisRtsBkMqGkpATld29KFpcwNGRHTU2NivDGjVL8/def+ONqMebm5hIBCwsLkZubi5SUU6o+jY3/oK2tTel4WXLySaUfGBhAQ0OD0p05c1bp0tPTE2u4ubmJ4eFh9PT04ONHGyYmJrCxsYG1tTWl7+zsVJeOj49ja2sLq6ur0hw7Ojo6MDIygrGxMezt7f0AjEQiiF8LCwtYXl5WjnoRgOBcx8fH8Pl8WFxcjEWlF7EMbcQ/6+vrcDgcmJychN/vV0Zerxejo6Mqal52dHQEl8sFt9sNj8eDnZ2dmH8sZY0ev/b39xO+CfS7s199Da3QSqa6vb2t0mbEjCAYDKq0d3d3sbKyovThcDhWlnj/WA0jDFuiCIlxUMACkp5farQku0/SDgqQX3bq5oUiy1LDTbGNHB4q34QaxofMXvnk5v+kbh3Syc9S0w8ymmNOJ2zS8fahIbT09cErzNj/TdqGRg9LkWdfvIBTOOaQ0Zp8/hyO2loMinTLf1t1Nb7ITh3PXbStr8fsy5fY8XhiWRqRaLG3hLCO8nJ8u3cP0w8fKnFWVOCDyDuR9/fvo092p5w7HzxQQlv6hD99igP8ES+4U0LRFAJCVKbNVL9K9HahzZeZGYwIZdaiWYWiPvEYRgyMNRBDFnqPHZRJCUjhg9Jd9/Q0ZgTUJw0Zl0u2QyFlQ1tEOahBE2kjcihd4xgdHBwo0c9bc3MzpqamFJ2oj+dmAm3wP4vsJzhXd3e3euLiO0o5jqaeMHr6gDeSrCQ1CauFZOYYBgIBRXI+JJr83LWPjtbQw89BZyr6VqbNN46zzBmmcHad0iRdCr34cLAU9FWATI2vB0eMh3rUGA0jZBSMjsJvAvJC2tCW47i0tKRsvwN9JX+tQ4WKFwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"loadbalance1\"\n        title=\"loadbalance1\"\n        src=\"/static/2231a88e4a9492cde687c77c874447a5/71ce0/loadbalance1.png\"\n        srcset=\"/static/2231a88e4a9492cde687c77c874447a5/4dcb9/loadbalance1.png 188w,\n/static/2231a88e4a9492cde687c77c874447a5/5ff7e/loadbalance1.png 375w,\n/static/2231a88e4a9492cde687c77c874447a5/71ce0/loadbalance1.png 463w\"\n        sizes=\"(max-width: 463px) 100vw, 463px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>The guidance below should considered just that - a guide.  In reality, your implementation may cross managerial boundaries - eg infrastructure for firewall and load balancer activities, and the BI team for SASjs Server setup and configuration.</p>\n<p>Also, you may have formal approval processes to install software such as nginx (or existing software that does the same job), hoops to jump through to open up ports, and so on.</p>\n<p>Finally, your configuration may differ according to the nature of your application(s), load profile, server specs etc.</p>\n<p>With that out of the way - let‚Äôs proceed!</p>\n<p>The assumptions are:</p>\n<ul>\n<li>You are a sysadmin and you have all necessary access rights</li>\n<li>You do not have a load balancer already configured</li>\n<li>You have the experience and authority to do all this stuff.</li>\n</ul>\n<p>The prerequisites are:</p>\n<ul>\n<li>3 functional and identical instances of SASjs Server (setup steps <a href=\"/sasjs-server-on-vps\">here</a>).</li>\n<li>A linux VPS for the load balancer, with root access</li>\n<li>A domain with corresponding TLS certificates</li>\n</ul>\n<h2>NGINX Basic Setup</h2>\n<p>SSH onto the load balancing server.  If nginx is not installed, install as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> nginx</code></pre></div>\n<p>Next, open the configuration ( eg <code class=\"language-text\">/etc/nginx/sites-available/default</code>) and using your preferred editor (<code class=\"language-text\">nano</code>, <code class=\"language-text\">vim</code>) and adjust the contents usuing the sample config below.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># List of backend SASjs server instances\n#  (internal/private IP + port)\nupstream mysasgrid {\n  server 10.110.0.8:5000;\n  server 10.110.0.11:5000;\n  server 10.110.0.10:5000;\n}\n\nserver {\n  listen 80;\n  location / {\n    proxy_pass http://mysasgrid;\n  }\n}</code></pre></div>\n<p>Finally, restart nginx:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo service nginx restart</code></pre></div>\n<p>That‚Äôs it! üöÄüöÄüöÄ</p>\n<hr/>\n<p>You should now be able to access the SASjs Server instances from the domain of the load balancer.  Simply run <code class=\"language-text\">%put &amp;=syshostname;</code> in Studio to see the domain of each node:</p>\n<p><img src=\"/2b54b1d7377d3f4585cdcdf0d2fe043d/loadbalance.gif\"></p>\n<p>If you are having troubles be sure to check the log file at <code class=\"language-text\">/var/log/nginx/error.log</code>.</p>\n<h2>NGINX Setup with TLS</h2>\n<p>To enable TLS (https) on the load balancer, you need to create a certificate and key.  The easiest way to do this is to use the Let‚Äôs Encrypt service - an example is provided in <a href=\"/sasjs-server-on-vps\">this article</a>.</p>\n<p>Once you have your <code class=\"language-text\">fullchain.pem</code> and <code class=\"language-text\">privkey.pem</code>, update the text below and use to replace the contents of <code class=\"language-text\">/etc/nginx/sites-available/default</code> as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">upstream mysasgrid {\n  server 10.110.0.8:5000;\n  server 10.110.0.11:5000;\n  server 10.110.0.10:5000;\n}\n\nserver {\n  listen              443 ssl;\n  # domain of your load balancer\n  server_name          demo.4gl.io;\n  # location of your certificates\n  ssl_certificate     /opt/certificates/fullchain.pem;\n  ssl_certificate_key /opt/certificates/privkey.pem;\n\n  location / {\n    proxy_pass http://mysasgrid;\n  }\n}</code></pre></div>\n<p>Save, re-run <code class=\"language-text\">sudo service nginx restart</code> and voila - your load balancer is configured to use TLS üîíüîíüîí</p>\n<p>Note that the SSL encryption terminates here at the load balancer - the node traffic runs over http. If you do not trust your internal network, or you are using external nodes, you may wish to configure SSL Passthrough - an article on that is <a href=\"https://www.cyberciti.biz/faq/configure-nginx-ssltls-passthru-with-tcp-load-balancing/\">here</a>.</p>\n<h2>NGINX Load Balancing Algorithms</h2>\n<p>By default, nginx will send traffic to each server sequentially (Round Robin).  However there may be reasons to use a different algorithm - for example, if you have servers with varying capacity, or reliability.</p>\n<p>Below are some examples of load balancing algorithms on nginx.</p>\n<h3>Weight</h3>\n<p>You can assign specific weights to each node, to allow more traffic to be sent to the servers with higher capacity.</p>\n<p>For instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">upstream mysasgrid {\n  server 10.110.0.8:5000 weight=1;\n  server 10.110.0.11:5000 weight=2;\n  server 10.110.0.10:5000 weight=6;\n}</code></pre></div>\n<p>In this case, the second server will receive twice as much traffic as the first.  The third will receive six times more traffic than the first.</p>\n<h3>Hash</h3>\n<p>By taking a hash of the IP of the request, you can route the requests for each visitor to the same SAS instance.  This is useful when your SAS app makes use of node-specific features, eg for session management.</p>\n<p>Note that if a server is down, it may be marked as such in order to redirect the requests.</p>\n<p>Example config:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">upstream mysasgrid {\n  ip_hash;\n  server 10.110.0.8:5000;\n  server 10.110.0.11:5000 down;\n  server 10.110.0.10:5000;\n}</code></pre></div>\n<p>In this example the second server is marked as down.</p>\n<h3>Max Fails</h3>\n<p>By default (Round Robin) requests are blindly forwarded to servers that are down / unresponsive.  The Max Fails algorithm deals with this using two parameters:</p>\n<ul>\n<li><a href=\"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#max_fails\"><code class=\"language-text\">max_fails</code></a> - the number of consecutive failures before the server is marked as down.</li>\n<li><a href=\"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#fail_timeout\"><code class=\"language-text\">fail_timeout</code></a> - how long to wait before the server is assumed to be back up.</li>\n</ul>\n<p>You can mix and match ‚ÄúMax Fails‚Äù with ‚ÄúWeight‚Äù and ‚ÄúHash‚Äù algorithms.  Example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">upstream mysasgrid {\n  ip_hash;\n  server 10.110.0.8:5000 weight=1 max_fails=1 fail_timeout=10s;\n  server 10.110.0.11:5000 max_fails=1 fail_timeout=1s;\n  server 10.110.0.10:5000 weight=6 max_fails=2 fail_timeout=1h;\n}</code></pre></div>\n<p>In this config:</p>\n<ul>\n<li>We are using IP hashing (each visitor will continue to use the same machine)</li>\n<li>The third server will get six times as much traffic as the other two (default weight is 1)</li>\n<li>If the third server fails twice, it will be out of action for 1 hour</li>\n<li>If the first server fails once, it is out of action for 10 seconds</li>\n</ul>\n<p>As you can see, NGINX is highly configurable.  Further options / algorithms (such as <a href=\"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#least_time\">least_time</a> or <a href=\"https://nginx.org/en/docs/http/ngx_http_upstream_module.html#least_conn\">least_conn</a>) are available if you take out a commercial subscription with nginx.</p>\n<h2>Deploying SAS Apps on Load Balanced Platforms</h2>\n<p>The key thing to remember is that the load balancer config above does not differentiate between web requests and SAS requests.  Therefore your app must be deployed to ALL the nodes in the cluster.</p>\n<p>If you would like to take security one step further, you could consider deploying the load balancer BEHIND the frontend application.  In this way, you can prevent end users from calling SAS services directly - by whitelisting the IP of the web server.  A topology for this is shown below:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 463px; margin-bottom: 1.0725rem;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 165.4255319148936%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAYAAADZPosTAAAACXBIWXMAAAsSAAALEgHS3X78AAAE10lEQVRIx41VWUtdVxQ+D2Ix1UIcHpwiTYVADdKmEYOND2kjrRWkaGObNMaHEKOmNaH9B40Q7Q8IphCi4JsFlYpWRSESZ5y1TtchTnG6eq/z/HV927uv53pN2g3r7H3W3vtb89oGHCMpKQkeHh7w9fWDl5c34uMTsLpqR1RUFDw9PeHn5y+zF9LTMzA1NYWAgAB4e3vD3z9A7r2H3Nw8hWPwc3BwgOTkZAQHhyIk2A9XPjPwbWIslpZsuHr1c+GfQ3CQDy5HGvj5pzRMTEzi/PkPERh4Dh9fOIOLFww8eZJzDLi/v4+UlBv4Oj4RP/4QjZtJBm589w0WF624fv0LJCQk4VZKJBK/MvDrL5mwWMZx6dKncucmbn8fjC9jDdEw9xhQmxwYFISYmGhEXf5ENE6BzbaC6Oho0eYjxMZeQWRkBLKysvH69QRCQkIQEXER167FIDw8XAB/d9XwdmoqQkNDcfasLwzDUKaurKwgLi5O8X18PlD8O3dSxeQJAYtAWFgYvM68r/iPH/92DHh4eIjBwUE0NTWhqupvNDY2YnR0VAnq6+tDc3Mz6urqZN2rwHZ3d9HV1YXq6mrUv3yJjo4OTE9PHwES7ORYW1vD1tYWtre31f/k5CTGxsYwNzenhHN/Y2NDWWAe3HNqSG04r66uKoltbW0YHh5WwASkZgQkUE9PD3p7exURnPeYKS5B0cDm9fr6uvNfX+Bs5p+8Z5iZemN5eVlJpkn0Df1Irbq7uzE7O6v2aInNZnO7a5yUon2kBwNVWVmJ0tJSlJWVSbIvufj6nRrqeXNzU/mns7NTaTgyMqL+qSWj29raqoLEc2btXKLsnMVHDAS1KSoqQk1NjaRSFSoqKhSPxDUF0JdmwKMok3H0xwxXtG63Y1PM2RENNsRX1sVFvKqvx7qsN2SP/C3Z5xmePyQ5MAy94KxJRZMV5FhvCZVIEsOxf+AgmO84MI5N3tvDZF4ehjMzMfLoEUayszEq1P3wISoePMCfaWmol/Ww8EY0ybmhe/cw+/y5010ugNM5ORi7exfjWVkYz8jAhNA/QrXp6SiW5vHq/n1YHHy1L4JGRdD8s2fHgCfD7pKwpnXv+Pip/JNZ4hplkWCdn4dNcs0uyU0qKixE4YsXyH/6FH/k5+Mvycc1SWi71arOrTAv5Z6OtlseskpYr8wxJu64aMbOw/QZGhpS7X9nZ0ftM210g3hrpejc4mB59ff3q8RmxVgsFlWGbB5W0fC0anEDNJeduSm0t7crTRsaGpQAPXSjeCsgzV2URCbRLBJ5BGO50USC2CXB2SjMDeLUbsPL8xIYziUlJSgoKEBxcTFaWlpQW1urmgRLkmAUqk1/p4ZspDSd9crWz9plQ6DvaPrAwIDS8s2bN/8PkOZQOtfkU2NqyKGjz4CxlfHsf0ZZD74pbF9s/4wyzdT9kAIZMAp1AzS3IErekzLkYa75rjCqNJXAzEXdJ/n68YwZww1QR1UnNwc1Ky8vV2uaSC0plGf0y+hWeppJzfgC8gIPc6YPGRjzIF+fc3tG6WT6TpcTJetHinlGs8hn9Kkt/7UV7O48x3J0+pCX6BttomqqjveYADMzM2om0Y9mrWgRA8Sz9KkzyvQNG4OuEq4piHxqQg14gUK5t7CwoIh5yDPUkvv/AkwrDZ9+T2nnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"loadbalance2\"\n        title=\"loadbalance2\"\n        src=\"/static/c0f0ecb448f2f8289977bd9c970cf5c0/71ce0/loadbalance2.png\"\n        srcset=\"/static/c0f0ecb448f2f8289977bd9c970cf5c0/4dcb9/loadbalance2.png 188w,\n/static/c0f0ecb448f2f8289977bd9c970cf5c0/5ff7e/loadbalance2.png 375w,\n/static/c0f0ecb448f2f8289977bd9c970cf5c0/71ce0/loadbalance2.png 463w\"\n        sizes=\"(max-width: 463px) 100vw, 463px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>This approach will only work if you are running an actual web server (eg NodeJS application) and frontend.  It won‚Äôt work for single page applications.</p>\n<p>If you‚Äôre interested to deploy such a solution, or you would like to partner with our team to deliver SAS Apps in other configurations, do <a href=\"/contact/\">get in touch</a>!</p>","frontmatter":{"title":"Load Balancing with SASjs Server","featuredImage":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAADtUlEQVQ4y3VUC0+TSRT9kBhMgEYKmiBgRGMw0NUgmG0Muz5IRP0BYkg0/hzkpb9iiUY0MSyEh3V5Q0FBiEhLC5S2QIECBcqbHu8ZO7U17iS38/XOvWfu49wxIKu/vx9ZWVlIS0uDOTMLKadS8eZNE9rb25GUlITTpzOQKfrUVBPs9mHU1dXBMAxkZGTImRl55/MxPz9PKBj86erqQn7+BeTlXcSVy8kothhobHyF1tZWuSgT2dnnUXw1CUUFBgYH7agXQLPZjHPnsmEtMXD9mgkzs96fgDabDaWlpXj0qArPqs7iTtkJvH7dhJaWf1FUZEFVVSWeVKajzJoi2QhgfS2s1jI8rqzA08qTKLuZB5fb8xOwt7cXOTk5sFgsuH3LioKCK2hqeisRtsBkMqGkpATld29KFpcwNGRHTU2NivDGjVL8/def+ONqMebm5hIBCwsLkZubi5SUU6o+jY3/oK2tTel4WXLySaUfGBhAQ0OD0p05c1bp0tPTE2u4ubmJ4eFh9PT04ONHGyYmJrCxsYG1tTWl7+zsVJeOj49ja2sLq6ur0hw7Ojo6MDIygrGxMezt7f0AjEQiiF8LCwtYXl5WjnoRgOBcx8fH8Pl8WFxcjEWlF7EMbcQ/6+vrcDgcmJychN/vV0Zerxejo6Mqal52dHQEl8sFt9sNj8eDnZ2dmH8sZY0ev/b39xO+CfS7s199Da3QSqa6vb2t0mbEjCAYDKq0d3d3sbKyovThcDhWlnj/WA0jDFuiCIlxUMACkp5farQku0/SDgqQX3bq5oUiy1LDTbGNHB4q34QaxofMXvnk5v+kbh3Syc9S0w8ymmNOJ2zS8fahIbT09cErzNj/TdqGRg9LkWdfvIBTOOaQ0Zp8/hyO2loMinTLf1t1Nb7ITh3PXbStr8fsy5fY8XhiWRqRaLG3hLCO8nJ8u3cP0w8fKnFWVOCDyDuR9/fvo092p5w7HzxQQlv6hD99igP8ES+4U0LRFAJCVKbNVL9K9HahzZeZGYwIZdaiWYWiPvEYRgyMNRBDFnqPHZRJCUjhg9Jd9/Q0ZgTUJw0Zl0u2QyFlQ1tEOahBE2kjcihd4xgdHBwo0c9bc3MzpqamFJ2oj+dmAm3wP4vsJzhXd3e3euLiO0o5jqaeMHr6gDeSrCQ1CauFZOYYBgIBRXI+JJr83LWPjtbQw89BZyr6VqbNN46zzBmmcHad0iRdCr34cLAU9FWATI2vB0eMh3rUGA0jZBSMjsJvAvJC2tCW47i0tKRsvwN9JX+tQ4WKFwAAAABJRU5ErkJggg==","width":400,"height":429,"src":"/static/2231a88e4a9492cde687c77c874447a5/497c6/loadbalance1.png","srcSet":"/static/2231a88e4a9492cde687c77c874447a5/497c6/loadbalance1.png 1x"}}},"path":"/load-balancing-sasjs-server","category":"SASjs Server","tags":["SASjs","SASjs Server","SAS Admin","SAS IntrNet","SAS"],"description":"Configuring an nginx Load Balancer with multiple SASjs Server Instances","date":"2022/07/28"}}},"pageContext":{}}}